{% extends 'index.html' %}
{% block ace-content %}
<style type="text/css"> 
	td.details-control {
	    background: url('/static/img/details_open.png') no-repeat center center;
	    cursor: pointer;
	}
	tr.shown td.details-control {
	    background: url('/static/img/details_close.png') no-repeat center center;
	} 
</style>	
{% endblock %}
{% block page-content %}
<div id="page-wrapper">
    <div class="row">
         <div class="col-lg-12">
              <h1 class="page-header"><i class="fa  fa-align-justify "></i> 游戏服清单</h1>
         </div>
                <!-- /.col-lg-12 -->
         
    </div>
	<div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-desktop fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{totalGame}}</div>
                                    <div>总游戏服数</div>
                                </div>
                            </div>
                        </div>
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-green">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-laptop fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{onlineGame}}</div>
                                    <div>已上线</div>
                                </div>
                            </div>
                        </div>
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-red">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-mobile-phone fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">{{offlineGame}}</div>
                                    <div>已下架</div>
                                </div>
                            </div>
                        </div>
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
     </div>     
    <div class="row">
         <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
							    <div class="btn-group btn-group-xs pull-right">
							    	<button type="button" class="btn btn-default" onclick="fcDumpsAssetsData(this)"><i class="fa fa-refresh fa-fw"></i>导出excl</button>
								    <button type="button" class="btn btn-default" onclick="updateAllAssets(this,'update')"><i class="fa fa-refresh fa-fw"></i>批量更新</button>
								</div>
                            	<i class="fa fa-database"></i>明细清单
                        </div>
                        <div class="panel-body">
                            <table width="100%" class="table table-striped table-bordered table-hover" id="ghostTableList">
                                <thead>
                                    <tr>
                                        <th class="text-center">详情</th>
                                        <th class="text-center"><input type="checkbox" onclick="checkAllBox()"/>全选</th>
                                        <th class="text-center">资产ID</th>
                                        <th class="text-center">产品线</th>
                                    	<th class="text-center">主机名称</th>
                                    	<th class="text-center">主机IP</th>
                                        <th class="text-center">操作系统</th>
                                        <th class="text-center">在运行游戏</th>
                                        <th class="text-center">激活状态</th>
                                        <th class="text-center">操作</th>
                                        <th class="text-center"></th>
                                    </tr>
                                    <tfoot>
                                        <tr>
                                            <th class="text-center">详情</th>
                                            <th class="text-center">全选</th>
                                            <th class="text-center">资产ID</th>
                                            <th class="text-center">产品线</th>
                                            <th class="text-center">主机名称</th>
                                            <th class="text-center">主机IP</th>
                                            <th class="text-center">操作系统</th>
                                            <th class="text-center">在运行游戏</th>
                                            <th class="text-center">激活状态</th>
                                            <th class="text-center">操作</th>
                                            <th class="text-center"></th>
                                        </tr>
                                    </tfoot>
                                </thead>
                                <tbody>
                                	{% for hs in gshost %}
                                        <tr class="odd gradeX">
                                            <td></td>
                                            <td class="text-center"><input type="checkbox" value={{hs.aid}} name="ckbox"/></td>
                                            <td class="text-center">{{hs.sid}}</td>
                                            <td class="text-center">{{hs.business}}</td>
                                            <td class="text-center">{{hs.hostname}}</td>
                                            <td class="text-center">{{hs.ip}}</td>
                                            <td class="text-center">{{hs.system}}</td>
                                            <td class="text-center">{{hs.onlinegame}}</td>
                                            <td class="text-center">
                                                {% if hs.status == 0 %}
                                                    <button  type="button" class="btn btn-outline btn-success">激活</button>
                                                {% elif hs.status == 1 %}
                                                    <button  type="button" class="btn btn-outline btn-primary">未激活</button>
                                                {% elif hs.status == 2 %}
                                                    <button  type="button" class="btn btn-outline btn-warning">维修中</button>
                                                {% elif hs.status == 3 %}
                                                    <button  type="button" class="btn btn-outline btn-info">已入库</button>
                                                {% elif hs.status == 4 %}
                                                    <button  type="button" class="btn btn-outline btn-default">未使用</button>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <a href="/assets_view/{{hs.aid}}" style="text-decoration:none;"><button  type="button" class="btn btn-default"><abbr title="查看详细信息"><i class="glyphicon glyphicon-info-sign"></i></abbr></button></a>
                                                <div class="btn-group">
                                                   <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                       <span class="glyphicon glyphicon-refresh"></span>
                                                       <span class="caret"></span>
                                                   </button>
                                                    <ul class="dropdown-menu" role="menu">
                                                        <li>
                                                            <a href="javascript:" onclick='gamehostUpdate(this,{{hs.sid}},"{{hs.ip}}","setup")'>更新主体信息</a>
                                                        </li>
                                                        <li>
                                                            <a href="javascript:" onclick='gamehostUpdate(this,{{hs.sid}},"{{hs.ip}}","syncdata")'>扫描游戏信息</a>
                                                        </li>
                                                    </ul>
                                                </div>

                                                <a href="/assets_mod/{{hs.aid}}" style="text-decoration:none;"><button  type="button" class="btn btn-default"><abbr title="修改资料"><i class="glyphicon glyphicon-edit"></i></abbr></button></a>
                                            </td>
                                            <td class="text-center">{{hs.game}}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="well">
                                <h4>添加说明</h4>
                                <p>没有任何游戏的新云主机在添加第一个游戏后会更新显示在列表里。</p>
                                <a class="btn btn-default btn-lg btn-block" href="/gs_add"><i class="fa fa-plus-circle "></i>添加新的游戏服</a>
                            </div>
                        </div>

                    </div>

                </div>
    </div>
</div>
<script type="text/javascript">
    var selectState = false;
    function checkAllBox(){
	  	var qcheck=document.getElementsByName("ckbox");
	  	for (var i = 0; i < qcheck.length; i++)
		  {
		    var checkbox = qcheck[i];
		    checkbox.checked = !selectState;
		  }
	  	selectState = !selectState;
	}

	function format ( dataList ) {
	    var trHtml = '';
		for (var i=0; i <dataList.length; i++){
		    if (dataList[i]["state"] == 1 )
            {
                var state = '<button  type="button" class="btn btn-outline btn-success">已上架</button>'
            }
            else if (dataList[i]["state"] == 0)
            {
                var state = '<button  type="button" class="btn btn-outline btn-danger">已下架</button>'
            }
            else
            {
                var state = '<button  type="button" class="btn btn-outline btn-danger">未上架</button>'
            }
			 trHtml +=  '<tr class="odd gradeX">'
                            +'<td class="text-center">'+dataList[i]["name"]+'</td>'
                                +'<td class="text-center">'+dataList[i]["gate_path"]+'</td>'
                                +'<td class="text-center">'+dataList[i]["game_path"]+'</td>'
                                +'<td class="text-center">'+state+'</td>'
                                +'<td class="text-center">'
                                    +'<a href="/gs_modf/'+dataList[i]["gid"]+'"><button  type="button" class="btn btn-default"><abbr title="编辑"><i class="glyphicon glyphicon-edit"></i></abbr></button></a>'
                                    +'<button  type="button" class="btn btn-default" onclick="deleteGameserver(this,'+dataList[i]["gid"]+')"><abbr title="删除"><i class="glyphicon glyphicon-trash"></i></abbr></button>'
                                +'</td>'
                        +'</tr>'

		};
 	    var vHtml = '<table width="100%" class="table table-striped table-bordered table-hover" id="gsTableList">'
                                +'<thead><tr>'
                                        +'<th class="text-center">游戏名称</th>'
                                        +'<th class="text-center">GateWay地址</th>'
                                        +'<th class="text-center">GameServer地址</th>'
                                    	+'<th class="text-center">已上架</th>'
                                        +'<th class="text-center">操作</th>'
                                    +'</tr><tfoot style="display: none"><tr>'
                                        +'<th class="text-center">游戏名称</th>'
                                        +'<th class="text-center">GateWay地址</th>'
                                        +'<th class="text-center">GameServer地址</th>'
                                    	+'<th class="text-center">已上架</th>'
                                        +'<th class="text-center">操作</th>'
                                        +'</tr></tfoot></thead><tbody>'
                                	            +trHtml
                                +'</tbody></table>';
	    return vHtml;
	}

    $(document).ready(function() {
	    var table = $('#ghostTableList').DataTable( {
/* 	        "ajax": "../ajax/data/objects.txt", */
	        "columns": [
	            {
	                "className": 'details-control',
	                "orderable": false,
	                "data":      null,
	                "defaultContent": ''
	            },
	            { "data": "全选" },
                { "data": "资产ID"},
	            { "data": "产品线" },
	            { "data": "主机名称" },
	            { "data": "主机IP" },
	            { "data": "操作系统" },
	            { "data": "在运行游戏" },
	            { "data": "激活状态" },
	            { "data": "操作" },
                {
                    "data": "游戏名称",
                    "visible":false
                }
	        ],
	        "order": [[2, 'asc']]
	    } );

	    // Add event listener for opening and closing details
        $('#ghostTableList tbody').on('click', 'td.details-control', function () {
	    	var dataList = [];
	        var tr = $(this).closest('tr');
	        var row = table.row( tr );
	        sId = row.data()["资产ID"];
	        $.ajax({
	            url : "/gs_config/"+sId+"/",
	            type : "get",
	            async : false,
	            dataType : "json",
	            success : function(result) {
	            	dataList = result.data;
	            }
	        });
/* 	    	console.log(dataList); */
	        if ( row.child.isShown() ) {
	            // This row is already open - close it
	            row.child.hide();
	            tr.removeClass('shown');
	        }
	        else {
	            // Open this row
	            row.child( format(dataList) ).show();
	            tr.addClass('shown');
                $('#gsTableList').DataTable( {
/* 	        "ajax": "../ajax/data/objects.txt", */
                    "searching" : false,
                    "info" : false,
                    "lengthChange" : false,
                    "paging" : false,
                    "columns": [
                        { "data": "游戏名称" },
                        { "data": "GateWay地址"},
                        { "data": "GameServer地址" },
                        { "data": "已上架" },
                        { "data": "操作" }
                    ],
                    "order": [[2, 'asc']]
	    } )
	        }

	    } );

	} );

    function gamehostUpdate(obj, id,ip,type){
			var btnObj = $(obj);
			var txt=  "是否确认更新？(会覆盖现有的配置和信息)";
			if (type==="setup"){
                var retitle="更新主机("+ip+")硬件信息"
                var reurl='/assets_facts/'
            }
            else if(type==="syncdata"){
                var retitle="更新主机"+ip+")游戏信息"
                var reurl='/gs_facts/'
            }
			var option = {
					title: retitle,
					btn: parseInt("0011",2),
					onOk: function(){
						$.ajax({
							  type: 'POST',
							  url: reurl,
							  data:{
									"ip":ip,
									"server_id":id,
									"type":type
								},
						      success:function(response){
					                if (response["code"]=="200"){
					                	window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);

					                }
						        	else{
						        		window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
						        	}
							},
				            error:function(response){
				            	window.wxc.xcConfirm("请求数据错误！", window.wxc.xcConfirm.typeEnum.error);
				            },
							});
					},
					onCancel:function(){
					},
					onClose:function(){
					}
				}
			window.wxc.xcConfirm(txt, "custom", option);
		}

    function deleteGameserver(obj,id){
    var txt=  "是否确认删除？";
    var btnObj = $(obj);
    btnObj.attr('disabled',true);
    var option = {
        title: "删除当前游戏服？",
        btn: parseInt("0011",2),
        onOk: function(){
            $.ajaxSetup({
                data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
            });
            $.ajax({
                  type: 'DELETE',
                  url: '/gs_details/'+id+'/',
                  success:function(response){
                          btnObj.removeAttr('disabled');
                          var r=confirm("删除成功!");
                          if (r==true)
                          {
                                location.reload('/gs_config/');
                          }
                  },
                  error:function(response){
                      btnObj.removeAttr('disabled');
                      var r=confirm(response.responseText);
                          if (r==true)
                          {
                                location.reload('/gs_config/');
                          }
                    }
                });
            },
            onCancel:function(){
            },
            onClose:function(){
            }
        }
    window.wxc.xcConfirm(txt, "custom", option);
    }

</script>
{% endblock %}