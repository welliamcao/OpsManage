{% extends 'index.html' %}
{% block ace-content %}
    <script type="text/javascript" src="/static/js/jquery.tablednd.js"></script>
    <link href="/static/dist/css/fileinput.css" media="all" rel="stylesheet" type="text/css" />
    <script src="/static/dist/js/fileinput.js" type="text/javascript"></script>
{% endblock %}
{% block page-content %}
    <div id="page-wrapper">
    <div class="row">
         <div class="col-lg-12">
              <h1 class="page-header"><i class="fa  fa-wrench"></i> 更新计划中心</h1>
         </div>
                <!-- /.col-lg-12 -->
    </div>
	<div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                           	 添加列表
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-6" style="float: left">
                                <legend>可选操作</legend>
                                    <button class="btn btn-default btn-lg btn-block" data-toggle="modal" data-target="#updateGamodal"><i class="fa fa-plus-circle "></i>添加程序更新</button>
                                    <button class="btn btn-default btn-lg btn-block" data-toggle="modal" data-target="#upstaticfimodal"><i class="fa fa-plus-circle "></i>添加静态配置更新</button>
                                    <button class="btn btn-default btn-lg btn-block" data-toggle="modal" data-target="#updynamicfimodal"><i class="fa fa-plus-circle "></i>添加动态配置更新</button>
                                    <button class="btn btn-default btn-lg btn-block" data-toggle="modal" data-target="#rebootmodal"><i class="fa fa-plus-circle "></i>重启程序</button>
                                    <button class="btn btn-default btn-lg btn-block" data-toggle="modal" data-target="#extracmdmodal"><i class="fa fa-plus-circle "></i>自定义更新命令</button>
                                </div>
                                <!-- /.col-lg-6 (nested) -->
                                <div class="col-lg-6" style="float: right">
                                <legend>计划列表</legend>
                                    <form role="form" method="post" id="addCrontab" class="main form-horizontal" enctype="multipart/form-data" >{% csrf_token %}
										<fieldset>
                                             <table width="100%" class="table table-striped table-bordered table-hover" id="updatelist">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center">ListID</th>
                                                        <th class="text-center">ID</th>
                                                        <th class="text-center">添加人</th>
                                                        <th class="text-center">操作类型</th>
                                                        <th class="text-center">更新源</th>
                                                        <th class="text-center">更新目标</th>
                                                        <th class="text-center">配置更新</th>
                                                    </tr>
                                                </thead>
                                                 <tbody>
                                                 </tbody>
                                            </table>
											</fieldset>
											<div class="form-group">
											<label class="col-sm-3 control-label"></label>
											<button type="reset"   class="btn btn-default" >撤销操作</button>
									 		<button type="submit"  class="btn btn-default" onclick="GenerateList()">确认提交</button>
									 		</div>

                                    </form>
                                </div>
                                <!-- /.col-lg-6 (nested) -->
                            </div>
                            <!-- /.row (nested) -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>    
</div>
<div class="modal fade" id="updateGamodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title" id="myModalLabel">
					添加程序更新
				</h4>
			</div>
			<div class="modal-body">
                <div class="row">
                    <form id="updateGa" class="form-horizontal" role="form">
                        <div class="form-group" id="souceform">
                            <label class="col-sm-3 control-label no-padding-right" for="form-field-4"><strong>更新源</strong></label>
                            <div class="col-sm-6">
                                <select class="selectpicker" id="sourceselect" onchange="source()" data-live-search="true"  data-size="5" name="sourceserver"  data-width="100%"  required>

                                </select>
                            </div>
                        </div>
                        <div id="srcfileform" class="form-group" style="display: none">
                            <div class="col-sm-12">
                                <table width="100%" class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center"><strong>更新源文件</strong></th>
                                            <th class="text-center">文件名</th>
                                            <th class="text-center">修改时间(mtime)</th>
                                            <th class="text-center">大小</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" for="form-field-4">
                                <strong>
                                更新目标
                                <abbr title="目标目录最新的文件将会_old"><i class="glyphicon glyphicon-info-sign"></i></abbr>
                                </strong>
                            </label>
                            <div class="col-sm-6">
                                <select class="selectpicker" id="targetselect" data-live-search="true"  data-size="5" name="targetserver"  data-width="100%"  required>

                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" for="form-field-4"><strong>是否有文件更新<abbr title="此更新会被拆分"><i class="glyphicon glyphicon-info-sign"></i></abbr></strong></label>
                            <div class="col-sm-6">
                                <label class="checkbox-inline col-sm-3">
                                    <input type="checkbox" onchange="hasfile(this)" name="hasconfig">
                                </label>
                            </div>
                        </div>
                        <div class="form-group" id="fileupload" style="display: none">
                            <label class="col-sm-3 control-label no-padding-right" for="form-field-4"><strong>配置文件<abbr title="静态默认config目录，动态gamedata"><i class="glyphicon glyphicon-info-sign"></i></abbr></strong></label>
                                <div class="col-sm-6">
                                    <input type="file" id="configfile" class="file" name="configfile" multiple="multiple" required>
                                </div>
                        </div>
				</form>
                </div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">关闭
				</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="addUPdate(this,'updateGa')">
					添加至列表
				</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal -->
</div>
<script type="text/javascript">
$(document).ready(
    serveropt="",
    $.ajax({
        url: '/api/gs/list/?format=json',
        dataType: 'json',
        type: 'get',
        success:function (response) {
            gslist=response
            for (var i=0; i <gslist.length; i++) {
                if (gslist[i]["state"]=="1"){
                    serveropt +=
                                 '<option name="server" value="'+gslist[i]["id"]+',game">'+gslist[i]["name"]+ '||' +gslist[i]["game_path"]+ '||' +gslist[i]["ip"]+'</option>'
                                +'<option name="server" value="'+gslist[i]["id"]+',gate">'+gslist[i]["name"]+ '||' +gslist[i]["gate_path"]+ '||' +gslist[i]["ip"]+'</option>'
                }
            }
            $("#sourceselect").append('<option name="server" value="" selected="selected">选择更新源</option>'+serveropt)
            $("#targetselect").append('<option name="server" value="" selected="selected">选择更新目标</option>'+serveropt)
            $("#sourceselect").selectpicker('refresh');
            $("#sourceselect").selectpicker('render');
            $("#targetselect").selectpicker('refresh');
            $("#targetselect").selectpicker('render');
        }
    })
)
function GenerateList(){

}

function addUPdate(obj,type){
    btnobj=$(obj)
    tlist=$('#updatelist').find('tbody')
    if (type=="updateGa"){
        form = document.getElementById('updateGa')
        for (i=0;i<form.length;i++){
            var name =form[i].name
            var value =form[i].value
            if (name=="sourceserver"){

            }
        }
        tlist.append()
    }
}

$("#configfile").fileinput({
	language : 'zh',
	showUpload : false,
	uploadUrl: '#', // you must set a valid URL here else you will get an error
	allowedFileExtensions : [".xml"],
	previewFileType:"pdf",
	allowedFileTypes: ["text"],
    overwriteInitial: false,
    maxFileSize: 2000,
    maxFilesNum: 10,
    dropZoneEnabled: false,
    textEncoding:'UTF-8',
    slugCallback: function(filename) {
        return filename.replace('(', '_').replace(']', '_');
    }
});

function hasfile(obj) {
    if ($(obj).is(":checked")){
        document.getElementById("fileupload").style.display="";
    }
    else {
        document.getElementById("fileupload").style.display="none";
    }
}

function source()
{

    filetbody=$("#srcfileform").find("tbody");
    filetbody.html("<tr><td>查找文件中...</td></tr>");
    document.getElementById("srcfileform").style.display="";
    valueslist=$("#sourceselect  option:selected").val().split(",");
    $.ajaxSetup({
                data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
            });
    $.ajax({
        url : "/reupdate/showfile/",
        type : "post",
        async : true,
        data:{
            "gid":valueslist[0],
            "ptype":valueslist[1]
        },
        success : function(result) {
            dataList = result.data;
            var datahtml="";
            for (var i=0; i <dataList.length; i++)
                {
                    datahtml+='<tr class="odd gradeX">'
                                +'<td class="text-center"><div class="radio"><label><input type="radio" name="filename" value="'+dataList[i]["name"]+'"></lable></div></td>'
                                +'<td>'+dataList[i]["name"]+'</td>'
                                +'<td>'+dataList[i]["mtime"]+'</td>'
                                +'<td>'+dataList[i]["size"]+'</td>'
                            +'</tr>'
                }
            filetbody.html(datahtml);
        }
        });

    }

	  {% if errorInfo %}
	  	window.wxc.xcConfirm("{{errorInfo}}", window.wxc.xcConfirm.typeEnum.error);
	  {% endif %}
</script>

{% endblock %}